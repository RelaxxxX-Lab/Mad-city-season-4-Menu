local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

repeat wait() until game:IsLoaded()
repeat wait() until player.Character
repeat wait() until player.Character:FindFirstChild("Humanoid")
repeat wait() until player.Character:FindFirstChild("HumanoidRootPart")

if _G.AutoRob == true then return end
_G.AutoRob = true

local character = player.Character
local hrp = character:WaitForChild("HumanoidRootPart")

local MiniRobberies = {
    "Cash", "CashRegister", "DiamondBox", "Laptop", "Phone", 
    "Luggage", "ATM", "TV", "Safe"
}

local function destroyLasers()
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj.Name:lower():find("laser") then
            obj:Destroy()
        end
    end
end

local function getEvent(model)
    for _, desc in next, model:GetDescendants() do
        if desc:IsA("RemoteEvent") then
            return desc
        end
    end
end

local function getModelPosition(model)
    if model.PrimaryPart then
        return model.PrimaryPart.Position
    end
    for _, part in ipairs(model:GetDescendants()) do
        if part:IsA("BasePart") then
            return part.Position
        end
    end
end

local function getAllTargets()
    local targets = {}
    for _, model in ipairs(workspace:FindFirstChild("ObjectSelection"):GetChildren()) do
        if table.find(MiniRobberies, model.Name) and not model:FindFirstChild("Nope") and getEvent(model) then
            table.insert(targets, model)
        end
    end
    return targets
end

local function sortByDistance(targets)
    table.sort(targets, function(a, b)
        return (getModelPosition(a) - hrp.Position).Magnitude < (getModelPosition(b) - hrp.Position).Magnitude
    end)
end

local function goToPosition(position, speed)
    local distance = (hrp.Position - position).Magnitude
    if distance < 10 then
        hrp.CFrame = CFrame.new(position)
        wait(0.1)
    else
        local time = distance / speed
        local tween = TweenService:Create(hrp, TweenInfo.new(time, Enum.EasingStyle.Linear), {CFrame = CFrame.new(position)})
        tween:Play()
        tween.Completed:Wait()
        wait(0.3)
    end
end

local function startRobberySequence()
    destroyLasers()
    local targets = getAllTargets()
    sortByDistance(targets)
    for _, model in ipairs(targets) do
        local pos = getModelPosition(model)
        if pos then
            goToPosition(pos, 600)
            local event = getEvent(model)
            if event then
                event:FireServer()
            end
            wait(0.1)
        end
    end
end

function shop()
    local success, _ = pcall(function()
        local servers = {}
        local url = "https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Desc&limit=100&excludeFullGames=true"
        local req = request({Url = url})
        local body = HttpService:JSONDecode(req.Body)

        if body and body.data then
            for _, server in ipairs(body.data) do
                if tonumber(server.playing) < tonumber(server.maxPlayers) and server.id ~= game.JobId then
                    table.insert(servers, server.id)
                end
            end
        end

        if #servers > 0 then
            TeleportService:TeleportToPlaceInstance(game.PlaceId, servers[math.random(1, #servers)], player)
        else
            if #Players:GetChildren() <= 1 then
                player:Kick("\nRejoining...")
                wait()
                TeleportService:Teleport(game.PlaceId, player)
            else
                TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, player)
            end
        end
    end)

    if not success then
        shop()
    end
end
player.Character:FindFirstChild("Humanoid").Died:Connect(function()
    shop()
end)

wait(2)
startRobberySequence()
wait(150)
shop()
